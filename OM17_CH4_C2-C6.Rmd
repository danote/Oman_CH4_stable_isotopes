---
title: "Methane and short-chain alkane C isotope data processing for samples obtained in Oman in 2017"
subtitle: "Source file: OM17_CH4_C2-C6.Rmd"
author: "Daniel Nothaft"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document: 
    df_print: paged # omit to disable paged data table output
    css: stylesheet.css # omit if no need for custom stylesheet
    number_sections: yes # change to no for unnumbered sections
    toc: yes # change to no to disable table of contents
    toc_float: true # change to false to keep toc at the top
    toc_depth: 3 # change to specify which headings to include in toc
    code_folding: show # change to hide to hide code by default
editor_options:
  chunk_output_type: inline
---

# Oman 2017 C$_1$-C$_6$ alkane $\delta^{13}$C - Introduction

C$_1$-C$_6$ alkane $\delta^{13}$C was measured by GC-C-IRMS as described in the methods section of the manuscript. The following code steps through the data processing and calibration to convert measured values to values vs. the international reference standard (Vienna Pee Dee Belemnite, VPDB). The gas samples processed in this document were collected in Oman in the February-March 2017 field season.

# Load libraries

```{r setup, warning=FALSE, message=FALSE}
# load libraries
library(tidyverse) # dplyr, tidyr, ggplot
library(isoreader) # reading isotope data files
library(isoprocessor) # processing isotope data files
```

Data processed using the packages [isoreader](http://isoreader.kopflab.org) version `r packageVersion("isoreader")` and [isoprocessor](http://isoprocessor.kopflab.org/) version `r packageVersion("isoprocessor")`.

# Load Data

```{r load-data, message=FALSE}
# read files
iso_files_raw <- 
  file.path(
    "data_raw/OM17_CH4_C2-C6_data", "OM17_CH4_C2-C6_data.cf.rds"
  ) %>% 
    # read data files in parallel for fast read
  iso_read_continuous_flow(parallel = TRUE)

# global knitting options for automatic saving of all plots as .png and .pdf
knitr::opts_chunk$set(
  dev = c("png", "pdf"), fig.keep = "all",
  dev.args = list(pdf = list(encoding = "WinAnsi", useDingbats = FALSE)),
  fig.path = file.path("fig_output/", paste0(gsub("\\.[Rr]md", "/", knitr::current_input()))),
  cache.path = file.path("cache/", paste0(gsub("\\.[Rr]md", "/", knitr::current_input())))
)
```

# Process file info & peak table

```{r process-file-info}
# process
iso_files <- iso_files_raw %>% 
  # set peak table from vendor data table
  iso_set_peak_table_from_auto_vendor_data_table() %>% 
  # # convert units from mV to V for amplitudes and area
  # iso_convert_peak_table_units(V = mV, Vs = mVs) %>%
  # rename key file info columns
  iso_rename_file_info(id1 = `Identifier 1`, inject_type = `Identifier 2`) %>%
  # parse text info into numbers
  iso_parse_file_info(number = Analysis) %>%
  # process other file information that is specific to the naming conventions
  # of this particular sequence
  iso_mutate_file_info(
    # was there seed oxidation?
    seed_oxidation = ifelse(`Seed Oxidation` == "1", "yes", "no"),
    # what was the injection volume?
    inject_volume = parse_number(Comment) %>% iso_double_with_units("uL"),
    # fix an sample id that was input erroneously
    id1 = ifelse(id1 == "Bio 1.0 Mid", "Bio 1.0 mid", id1),
    # what folder are the data files in? (assuming folder = sequence)
    folder = basename(dirname(file_path))
  )
```


## Peak maps
```{r set-peak-maps}
# set peak maps
peak_maps <- 
  tibble::tribble(
    ~compound, ~ref_nr, ~`rt`,
    # peak map data (row-by-row)
    "CO2",          1,      39,
    "CO2",          2,      74,
    "CO2",          3,      108,
    "CO2",          4,      143,
    "CH4",          NA,     330,
    "CO2",          NA,     447,
    "C2",           NA,     1290,
    "C3",           NA,     1640,
    "C4-iso",       NA,     1785,
    "C4-n",         NA,     1806,
    "C5-iso",       NA,     1928,
    "C5-n",         NA,     1941,
    "C6",           NA,     2057
  )

# print
peak_maps %>% knitr::kable(digits = 0)
```

## Fetch peak table
```{r fetch-peak-table}
# identify peaks
peak_table_w_ids <- iso_files %>% 
  iso_map_peaks(peak_maps) %>%
  # peak table
  iso_get_peak_table(include_file_info = everything())
```

## Select analyte peaks
```{r select-analyte-peaks}
# focus on analyte peaks

 # We separately tested and determined the limit of quantitation (defined here as amplitude yielding d13C sample standard deviation of 0.6 per mil over studied amplitude range) for our intrument setup. Note: NSHQ14 was only gas sample with C2-C6 above LOQ in 2017.

peak_table_analytes <- peak_table_w_ids %>% 
    filter(amp44 > 300)

  # omit reference peaks for downstream processing (i.e. analyte peaks only) and select only peaks where good chromatographic separation has been demonstrated. Note: baseline separation of C4+ alkanes was not comprehensively determined for the chromatographic method used for these samples, so only C1-C3 alkane data are used for downstream processing.

peak_table_analytes <- peak_table_analytes %>%  
  filter(compound == "CH4" | compound == "C2" | compound == "C3")

# print
peak_table_analytes %>% select(file_id, compound, amp44) %>%  knitr::kable(d=0)
```

# Isotope standard values

## Load isotope standards

```{r set-stnd-d13C}
# input accepted d13C of standards
standards <- 
  tibble::tribble(
    ~id1,             ~true_d13C,
    "T-ISO1",			    -38.3,
    "H-ISO1",			    -23.9,
    "Bio 1.0 mid",		-68.6
  ) %>% 
  mutate(
    true_d13C = iso_double_with_units(true_d13C, "permil")
  )

# print
standards %>% knitr::kable(digits = 2)
```

## Add isotope standards
```{r add-stnds-to-peak-table}
peak_table_w_stds <- 
  peak_table_analytes %>% 
  iso_add_standards(stds = standards, match_by = c("id1")) 

# print
peak_table_w_stds %>% select(file_id, compound, amp44) %>%  knitr::kable(d=0)
```

# Calibration

## Generate a calibration with linear regression

Note: Separate testing indicated that the effect of peak amplitude on $\delta^{13}$C (i.e. linearity) was within a repeatability of 0.6 per mil over the range of peak amplitudes measured here. Since only CH$_4$ isotope standards were available to us for testing, and the peak amplitude/$\delta^{13}$C effect observed for these standards may differ from those observed for $\text{C}_{2}-\text{C}_6$ alkanes, which have different peak shapes than CH$_4$, calibrations based on peak amplitude are not applied here.
```{r generate-calib}
global_calibs <- peak_table_w_stds %>%
  # prepare for calibration
  iso_prepare_for_calibration() %>% 
  # run calibrations
  iso_generate_calibration(
    model = c(
      # reference scale correction
      delta_only = lm(d13C ~ true_d13C),
      # multivariate with delta and the datetime (i.e. checking for temporal drift)
      delta_and_time = lm(d13C ~ true_d13C + file_datetime)
    ), 
    # specify which peaks to include in the calibration, here:
    # - all std_peaks (this filter should always be included!)
    use_in_calib = is_std_peak
  ) 
```

## Apply global calibration
```{r apply-calibs, cache=TRUE}
global_calibs_applied <- 
  global_calibs %>% 
  # which calibration to use? can include multiple if desired to see the result
  # in this case, the amplitude- and time-conscious calibrations are not necessary
  filter(calib == "delta_only") %>% 
  # apply calibration indication what should be calculated
  iso_apply_calibration(true_d13C, calculate_error = TRUE)
# calibration ranges
global_calibs_with_ranges <-
  global_calibs_applied %>%
  # evaluate calibration range for the measured amplitude and predicted d13C
  iso_evaluate_calibration_range(amp44, true_d13C_pred)
# show calibration ranges
global_calibs_with_ranges %>%
  iso_get_calibration_range() %>%
  iso_remove_list_columns() %>%
  knitr::kable(d = 2)
# create calibrated peak table
peak_table_calibrated <- global_calibs_with_ranges %>%
  iso_get_calibration_data()

# # create calibrated peak table
# peak_table_calibrated <- global_calibs_applied %>%
#   iso_get_calibration_data()
```

```{r}
peak_table_calibrated  %>% select(file_id, compound, amp44) %>%  knitr::kable(d=0)
```


# Inspect calibration

## Summary
```{r}
# generate data summary
peak_data <-
  peak_table_calibrated %>%
  # focus on identified peaks in the samples
  filter(!is.na(compound))

peak_data  %>% select(file_id, compound, amp44) %>%  knitr::kable(d=0)
```



```{r summarize-calibrated-data}
# # generate data summary
# peak_data <- 
#   peak_table_calibrated %>% 
#   # focus on identified peaks in the samples
#   filter(!is.na(compound))
# 
# # Add simpler sample names
# peak_data <- peak_data %>% mutate(sample = case_when(
#   str_detect(id1, "Bio") == TRUE ~ "Bio 1.0 mid",
#   str_detect(id1, "H-ISO1") == TRUE ~ "H-ISO1",
#   str_detect(id1, "T-ISO1") == TRUE ~ "T-ISO1",
#   str_detect(id1, "14") == TRUE ~ "NSHQ14",
#   str_detect(id1, "OM17-4_DBN_DC") == TRUE ~ "NSHQ04",
#   str_detect(id1, "71") == TRUE ~ "WAB71",
#   str_detect(id1, "188") == TRUE ~ "WAB188"
# ))
# 
# # summarize replicates
# peak_data_summary <- 
#   peak_data %>% 
#   # summarize for each sample and compound
#   group_by(sample, compound) %>% 
#   iso_summarize_data_table(amp44, true_d13C_pred, true_d13C_pred_se) %>% select(-`true_d13C_pred_se sd`)
# 
# # add column in which d13C is rounded to tenth of permil place
# peak_data_summary <- peak_data_summary %>% mutate(`d13C rounded tenth` = round(`true_d13C_pred mean`, 1))
# 
#   # re-apply filters just to be certain no inadequate data gets exported
# 
# # peak_data_summary <- peak_data_summary %>%
# #     filter(`amp44 mean` > 300)
# # 
# # peak_data_summary <- peak_data_summary %>%
# #   filter(compound == "CH4" | compound == "C2" | compound == "C3")
# 
# # print
# peak_data_summary %>% iso_make_units_explicit() %>% knitr::kable(d = 2)
```